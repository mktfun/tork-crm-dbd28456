import { useState } from 'react';
import { Loader2, Landmark, Check, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Alert, AlertDescription } from '@/components/ui/alert';

import { useBankAccounts } from '@/hooks/useBancos';
import { useSettleCommission } from '@/hooks/useFinanceiro';

interface SettleTransactionModalProps {
  open: boolean;
  onClose: () => void;
  transactionIds: string[];
  totalAmount: number;
  onSuccess?: () => void;
}

function formatCurrency(value: number): string {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(value);
}

export function SettleTransactionModal({
  open,
  onClose,
  transactionIds,
  totalAmount,
  onSuccess
}: SettleTransactionModalProps) {
  const [selectedAccountId, setSelectedAccountId] = useState<string>('');
  const [isSettling, setIsSettling] = useState(false);

  const { data: bankSummary, isLoading: accountsLoading } = useBankAccounts();
  const accounts = bankSummary?.accounts ?? [];
  const settleCommission = useSettleCommission();

  const handleSettle = async () => {
    console.log('üè¶ SETTLE MODAL - Iniciando baixa:', {
      transactionIds,
      selectedAccountId,
      totalAmount
    });

    if (!selectedAccountId) {
      toast.error('Selecione uma conta de destino');
      return;
    }

    setIsSettling(true);

    try {
      let successCount = 0;
      let errorCount = 0;

      for (const transactionId of transactionIds) {
        console.log('üè¶ SETTLE MODAL - Processando transa√ß√£o:', transactionId);
        try {
          const result = await settleCommission.mutateAsync({
            transactionId,
            bankAccountId: selectedAccountId,
          });
          console.log('‚úÖ SETTLE MODAL - Sucesso:', { transactionId, result });
          successCount++;
        } catch (error: any) {
          console.error('‚ùå SETTLE MODAL - Erro:', {
            transactionId,
            errorMessage: error?.message || error,
            errorDetails: error
          });
          errorCount++;
        }
      }

      if (successCount > 0) {
        toast.success(`${successCount} receita(s) confirmada(s) com sucesso!`);
        onSuccess?.();
        onClose();
      }

      if (errorCount > 0) {
        toast.error(`${errorCount} receita(s) n√£o puderam ser confirmadas.`);
      }
    } finally {
      setIsSettling(false);
      setSelectedAccountId('');
    }
  };

  const handleClose = () => {
    if (!isSettling) {
      setSelectedAccountId('');
      onClose();
    }
  };

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Landmark className="w-5 h-5 text-primary" />
            Confirmar Recebimento
          </DialogTitle>
          <DialogDescription>
            Selecione a conta banc√°ria para registrar a entrada do valor.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* Resumo */}
          <div className="p-4 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
            <div className="flex items-center justify-between">
              <span className="text-sm text-muted-foreground">
                {transactionIds.length} transa√ß√£o(√µes)
              </span>
              <span className="text-lg font-bold text-emerald-600">
                {formatCurrency(totalAmount)}
              </span>
            </div>
          </div>

          {/* Sele√ß√£o de conta */}
          <div className="space-y-2">
            <Label htmlFor="account">Em qual conta o dinheiro entrou? *</Label>
            {accountsLoading ? (
              <div className="flex items-center gap-2 text-sm text-muted-foreground">
                <Loader2 className="w-4 h-4 animate-spin" />
                Carregando contas...
              </div>
            ) : accounts.length === 0 ? (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>
                  Nenhuma conta banc√°ria cadastrada. V√° em Configura√ß√µes para criar uma conta.
                </AlertDescription>
              </Alert>
            ) : (
              <Select
                value={selectedAccountId}
                onValueChange={setSelectedAccountId}
                disabled={isSettling}
              >
                <SelectTrigger id="account">
                  <SelectValue placeholder="Selecione a conta banc√°ria" />
                </SelectTrigger>
                <SelectContent>
                  {accounts.map((account) => (
                    <SelectItem key={account.id} value={account.id}>
                      <div className="flex items-center gap-2">
                        {account.color && (
                          <div
                            className="w-3 h-3 rounded-full"
                            style={{ backgroundColor: account.color }}
                          />
                        )}
                        <span>{account.bankName}</span>
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            )}
          </div>

          <p className="text-xs text-muted-foreground">
            A baixa ser√° registrada como entrada na conta selecionada e a comiss√£o ser√°
            marcada como recebida.
          </p>
        </div>

        <DialogFooter>
          <Button
            variant="outline"
            onClick={handleClose}
            disabled={isSettling}
          >
            Cancelar
          </Button>
          <Button
            onClick={handleSettle}
            disabled={!selectedAccountId || isSettling || accounts.length === 0}
            className="gap-2 bg-emerald-600 hover:bg-emerald-700"
          >
            {isSettling ? (
              <>
                <Loader2 className="w-4 h-4 animate-spin" />
                Processando...
              </>
            ) : (
              <>
                <Check className="w-4 h-4" />
                Confirmar Recebimento
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
